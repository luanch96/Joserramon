

COMPOSE_CMD = docker-compose -f srcs/docker-compose.yml


# Obtener automÃ¡ticamente el HOME y el usuario actual
# Preservar el usuario original incluso si se ejecuta con sudo
USER_NAME := $(shell bash -c 'echo $${SUDO_USER:-$$USER}')
HOST_HOME := $(shell bash -c 'if [ -n "$$SUDO_USER" ]; then echo ~$$SUDO_USER; else echo $$HOME; fi')
DOMAIN_NAME ?= $(USER_NAME).42.fr

export DOMAIN_NAME
export HOST_HOME

.PHONY: all build up run down restart clean fclean test

all: run

build:
	@if [ -z "$(HOST_HOME)" ]; then \
		echo "âŒ Error: HOST_HOME no estÃ¡ definido. Por favor ejecuta desde el Makefile."; \
		exit 1; \
	fi
	@if [ -z "$(DOMAIN_NAME)" ]; then \
		echo "âŒ Error: DOMAIN_NAME no estÃ¡ definido. Por favor ejecuta desde el Makefile."; \
		exit 1; \
	fi
	@echo "ğŸ”¨ Construyendo imÃ¡genes con HOST_HOME=$(HOST_HOME) y DOMAIN_NAME=$(DOMAIN_NAME)..."
	HOST_HOME=$(HOST_HOME) DOMAIN_NAME=$(DOMAIN_NAME) $(COMPOSE_CMD) build

up:
	@if [ -z "$(HOST_HOME)" ]; then \
		echo "âŒ Error: HOST_HOME no estÃ¡ definido. Por favor ejecuta desde el Makefile."; \
		exit 1; \
	fi
	@if [ -z "$(DOMAIN_NAME)" ]; then \
		echo "âŒ Error: DOMAIN_NAME no estÃ¡ definido. Por favor ejecuta desde el Makefile."; \
		exit 1; \
	fi
	@echo "ğŸš€ Iniciando contenedores con HOST_HOME=$(HOST_HOME) y DOMAIN_NAME=$(DOMAIN_NAME)..."
	HOST_HOME=$(HOST_HOME) DOMAIN_NAME=$(DOMAIN_NAME) $(COMPOSE_CMD) up -d

run: build up
	@echo "âœ… Todos los contenedores se han iniciado correctamente."
	@echo "ğŸŒ Accede a https://$(DOMAIN_NAME)"

down:
	$(COMPOSE_CMD) down -v

restart: down up

clean:
	@docker stop $$(docker ps -qa) 2>/dev/null || true; \
	docker rm $$(docker ps -qa) 2>/dev/null || true; \
	docker rmi -f $$(docker images -qa) 2>/dev/null || true; \
	docker volume rm $$(docker volume ls -q) 2>/dev/null || true; \
	docker network rm $$(docker network ls -q) 2>/dev/null || true; \
	docker system prune -f --volumes

fclean: clean
	sudo rm -rf $(HOME)/data/mariadb/*
	sudo rm -rf $(HOME)/data/wordpress/*
	@echo "ğŸ—‘ï¸  Todo limpio âœ…"

setup:
	@echo "ğŸ“ Creando directorios para volÃºmenes..."
	@echo "ğŸ“ Usuario: $(USER_NAME)"
	@echo "ğŸ  HOME: $(HOST_HOME)"
	@echo "ğŸŒ Dominio: $(DOMAIN_NAME)"
	@mkdir -p $(HOST_HOME)/data/mariadb $(HOST_HOME)/data/wordpress $(HOST_HOME)/data/ssl
	@if [ -n "$$SUDO_USER" ]; then \
		chown -R $$SUDO_USER:$$SUDO_USER $(HOST_HOME)/data; \
	fi
	@chmod -R 755 $(HOST_HOME)/data
	@echo "ğŸ” Generando certificados SSL para $(DOMAIN_NAME)..."
	@bash -c 'DOMAIN_NAME=$(DOMAIN_NAME) SSL_DIR=$(HOST_HOME)/data/ssl HOME=$(HOST_HOME) ./srcs/requirements/nginx/tools/generate-ssl.sh'
	@if [ -n "$$SUDO_USER" ]; then \
		chown $$SUDO_USER:$$SUDO_USER $(HOST_HOME)/data/ssl/* 2>/dev/null || true; \
	fi
	@echo "âœ… Directorios creados correctamente"
	@echo ""
	@echo "ğŸ”§ Configurando /etc/hosts..."
	@if ! grep -q "$(DOMAIN_NAME)" /etc/hosts 2>/dev/null; then \
		echo "âš ï¸  Necesitas agregar el dominio a /etc/hosts manualmente:"; \
		echo "   Ejecuta: sudo bash -c 'echo \"127.0.0.1 $(DOMAIN_NAME)\" >> /etc/hosts'"; \
	else \
		echo "âœ… Dominio ya estÃ¡ en /etc/hosts"; \
	fi

test:
	@echo "ğŸ§ª Ejecutando pruebas de conectividad..."
	@./test-connectivity.sh
	@echo ""
	@echo "ğŸ§ª Verificando base de datos..."
	@./check-database.sh

info:
	@echo "ğŸŒ Servicios disponibles:"
	@echo "  WordPress: https://$(DOMAIN_NAME)"
	@echo ""
	@echo "ğŸ“Š Estado de contenedores:"
	@$(COMPOSE_CMD) ps